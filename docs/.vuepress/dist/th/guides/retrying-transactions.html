<!DOCTYPE html>
<html lang="th-TH">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta name="title" content="คู่มือ Solana | Retrying Transactions"><meta name="og:title" content="คู่มือ Solana | Retrying Transactions"><meta name="description" content="ในบางที transaction อาจจะถูกทิ้งไปก่อนที่จะเข้าไปใน block เพื่อแก้ปัญหานี้นักพัฒนา app สามารถสร้างเงื่อนไขเพื่อส่งไปอีกครั้งได้ เรียนรู้เกี่ยวกับ retrying transactions และเรื่องอื่นๆ ได้ที่คู่มือ Solana."><meta name="og:description" content="ในบางที transaction อาจจะถูกทิ้งไปก่อนที่จะเข้าไปใน block เพื่อแก้ปัญหานี้นักพัฒนา app สามารถสร้างเงื่อนไขเพื่อส่งไปอีกครั้งได้ เรียนรู้เกี่ยวกับ retrying transactions และเรื่องอื่นๆ ได้ที่คู่มือ Solana."><meta name="og:image" content="https://solanacookbook.com/cookbook-sharing-card.png"><meta name="og:image:alt" content="Solana splash card"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@solanacookbook"><meta name="twitter:image" content="https://solanacookbook.com/cookbook-sharing-card.png"><meta name="robots" content="index,follow,noodp"><meta name="googlebot" content="index,follow"><link rel="icon" href="/solana_cookbook_lightmode.svg"><script data-domain="solanacookbook.com" src="https://plausible.io/js/plausible.js"></script><title>Retrying Transactions | คู่มือ Solana</title>
    <link rel="modulepreload" href="/assets/app.28f6b3e6.js"><link rel="modulepreload" href="/assets/retrying-transactions.html.52526203.js"><link rel="modulepreload" href="/assets/retrying-transactions.html.6907f55e.js">
    <link rel="stylesheet" href="/assets/style.fecd2c41.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/th/" class=""><!----><span class="site-name can-hide">คู่มือ Solana</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/solana-developers/solana-cookbook" rel="noopener noreferrer" target="_blank" aria-label="ร่วมกันเขียน"><!--[--><!--]--> ร่วมกันเขียน <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/th/integrations" class="" aria-label="การใช้งาน"><!--[--><!--]--> การใช้งาน <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/guides/retrying-transactions.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/" class="" aria-label="中文"><!--[--><!--]--> 中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/es/guides/retrying-transactions.html" class="" aria-label="Spanish"><!--[--><!--]--> Spanish <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/vi/guides/retrying-transactions.html" class="" aria-label="Tiếng Việt"><!--[--><!--]--> Tiếng Việt <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/th/guides/retrying-transactions.html" class="router-link-active router-link-exact-active router-link-active" aria-label="ไทย"><!--[--><!--]--> ไทย <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/id/guides/retrying-transactions.html" class="" aria-label="Bahasa Indonesia"><!--[--><!--]--> Bahasa Indonesia <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/solana-developers/solana-cookbook" rel="noopener noreferrer" target="_blank" aria-label="ร่วมกันเขียน"><!--[--><!--]--> ร่วมกันเขียน <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/th/integrations" class="" aria-label="การใช้งาน"><!--[--><!--]--> การใช้งาน <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/guides/retrying-transactions.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/" class="" aria-label="中文"><!--[--><!--]--> 中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/es/guides/retrying-transactions.html" class="" aria-label="Spanish"><!--[--><!--]--> Spanish <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/vi/guides/retrying-transactions.html" class="" aria-label="Tiếng Việt"><!--[--><!--]--> Tiếng Việt <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/th/guides/retrying-transactions.html" class="router-link-active router-link-exact-active router-link-active" aria-label="ไทย"><!--[--><!--]--> ไทย <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/id/guides/retrying-transactions.html" class="" aria-label="Bahasa Indonesia"><!--[--><!--]--> Bahasa Indonesia <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">เริ่มต้น <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/th/" class="sidebar-item" aria-label="Cooking กับ Solana"><!--[--><!--]--> Cooking กับ Solana <!--[--><!--]--></a><!----></li><li><a href="/th/getting-started/installation.html" class="sidebar-item" aria-label="การติดตั้ง"><!--[--><!--]--> การติดตั้ง <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">แนวความคิดหลัก <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/th/core-concepts/accounts.html" class="sidebar-item" aria-label="Accounts"><!--[--><!--]--> Accounts <!--[--><!--]--></a><!----></li><li><a href="/th/core-concepts/programs.html" class="sidebar-item" aria-label="Programs"><!--[--><!--]--> Programs <!--[--><!--]--></a><!----></li><li><a href="/th/core-concepts/transactions.html" class="sidebar-item" aria-label="Transactions"><!--[--><!--]--> Transactions <!--[--><!--]--></a><!----></li><li><a href="/th/core-concepts/pdas.html" class="sidebar-item" aria-label="Program Derived Addresses (PDAs)"><!--[--><!--]--> Program Derived Addresses (PDAs) <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">แนวทาง <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/th/guides/get-program-accounts.html" class="sidebar-item" aria-label="Get Program Accounts"><!--[--><!--]--> Get Program Accounts <!--[--><!--]--></a><!----></li><li><a href="/th/guides/serialization.html" class="sidebar-item" aria-label="Serializing Data"><!--[--><!--]--> Serializing Data <!--[--><!--]--></a><!----></li><li><a href="/th/guides/data-migration.html" class="sidebar-item" aria-label="Migrating Program Data Accounts"><!--[--><!--]--> Migrating Program Data Accounts <!--[--><!--]--></a><!----></li><li><a href="/th/guides/account-maps.html" class="sidebar-item" aria-label="Account Maps"><!--[--><!--]--> Account Maps <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Retrying Transactions"><!--[--><!--]--> Retrying Transactions <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/th/guides/retrying-transactions.html#เรื่องน่ารู้" class="router-link-active router-link-exact-active sidebar-item" aria-label="เรื่องน่ารู้"><!--[--><!--]--> เรื่องน่ารู้ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html#การเดินทางของ-transaction" class="router-link-active router-link-exact-active sidebar-item" aria-label="การเดินทางของ Transaction"><!--[--><!--]--> การเดินทางของ Transaction <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/th/guides/retrying-transactions.html#clients-submit-transactions-ยังไง" class="router-link-active router-link-exact-active sidebar-item" aria-label="Clients Submit Transactions ยังไง"><!--[--><!--]--> Clients Submit Transactions ยังไง <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html#rpc-nodes-broadcast-transactions-ยังไง" class="router-link-active router-link-exact-active sidebar-item" aria-label="RPC Nodes Broadcast Transactions ยังไง"><!--[--><!--]--> RPC Nodes Broadcast Transactions ยังไง <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html#transactions-ถูกทิ้งไปได้ยังไง" class="router-link-active router-link-exact-active sidebar-item" aria-label="Transactions ถูกทิ้งไปได้ยังไง"><!--[--><!--]--> Transactions ถูกทิ้งไปได้ยังไง <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/th/guides/retrying-transactions.html#ก่อน-transaction-จะประมวลผลเสร็จ" class="router-link-active router-link-exact-active sidebar-item" aria-label="ก่อน transaction จะประมวลผลเสร็จ"><!--[--><!--]--> ก่อน transaction จะประมวลผลเสร็จ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html#หลังจาก-transaction-ประมวลผลเสร็จ-และก่อนจะ-finalized" class="router-link-active router-link-exact-active sidebar-item" aria-label="หลังจาก transaction ประมวลผลเสร็จ และก่อนจะ finalized"><!--[--><!--]--> หลังจาก transaction ประมวลผลเสร็จ และก่อนจะ finalized <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html#จัดการ-transactions-ที่ถูกทิ้ง" class="router-link-active router-link-exact-active sidebar-item" aria-label="จัดการ Transactions ที่ถูกทิ้ง"><!--[--><!--]--> จัดการ Transactions ที่ถูกทิ้ง <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/th/guides/retrying-transactions.html#sendtransaction-เชิงลึก" class="router-link-active router-link-exact-active sidebar-item" aria-label="sendTransaction เชิงลึก"><!--[--><!--]--> sendTransaction เชิงลึก <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html#ทํา-rebroadcast-logic-เอง" class="router-link-active router-link-exact-active sidebar-item" aria-label="ทำ Rebroadcast Logic เอง"><!--[--><!--]--> ทำ Rebroadcast Logic เอง <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/th/guides/retrying-transactions.html#จะเกิดอะไรขึ้นถ้า-skip-preflight" class="router-link-active router-link-exact-active sidebar-item" aria-label="จะเกิดอะไรขึ้นถ้า Skip Preflight"><!--[--><!--]--> จะเกิดอะไรขึ้นถ้า Skip Preflight <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html#re-sign-transactions-เมื่อไหร่ดี" class="router-link-active router-link-exact-active sidebar-item" aria-label="Re-Sign Transactions เมื่อไหร่ดี"><!--[--><!--]--> Re-Sign Transactions เมื่อไหร่ดี <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/th/guides/retrying-transactions.html#acknowledgements" class="router-link-active router-link-exact-active sidebar-item" aria-label="Acknowledgements"><!--[--><!--]--> Acknowledgements <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/th/guides/debugging-solana-programs.html" class="sidebar-item" aria-label="Debugging Solana Programs"><!--[--><!--]--> Debugging Solana Programs <!--[--><!--]--></a><!----></li><li><a href="/th/guides/feature-parity-testing.html" class="sidebar-item" aria-label="Feature Parity Testing"><!--[--><!--]--> Feature Parity Testing <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">อ้างอิง <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/th/references/local-development.html" class="sidebar-item" aria-label="Local Development"><!--[--><!--]--> Local Development <!--[--><!--]--></a><!----></li><li><a href="/th/references/keypairs-and-wallets.html" class="sidebar-item" aria-label="Keypairs และ Wallets"><!--[--><!--]--> Keypairs และ Wallets <!--[--><!--]--></a><!----></li><li><a href="/th/references/basic-transactions.html" class="sidebar-item" aria-label="Sending Transactions"><!--[--><!--]--> Sending Transactions <!--[--><!--]--></a><!----></li><li><a href="/th/references/accounts.html" class="sidebar-item" aria-label="Accounts"><!--[--><!--]--> Accounts <!--[--><!--]--></a><!----></li><li><a href="/th/references/programs.html" class="sidebar-item" aria-label="เขียน Programs"><!--[--><!--]--> เขียน Programs <!--[--><!--]--></a><!----></li><li><a href="/th/references/token.html" class="sidebar-item" aria-label="การใช้งาน Tokens"><!--[--><!--]--> การใช้งาน Tokens <!--[--><!--]--></a><!----></li><li><a href="/th/references/staking.html" class="sidebar-item" aria-label="Staking"><!--[--><!--]--> Staking <!--[--><!--]--></a><!----></li><li><a href="/th/references/nfts.html" class="sidebar-item" aria-label="NFTs"><!--[--><!--]--> NFTs <!--[--><!--]--></a><!----></li><li><a href="/th/references/offline-transactions.html" class="sidebar-item" aria-label="Sending Offline Transactions"><!--[--><!--]--> Sending Offline Transactions <!--[--><!--]--></a><!----></li><li><a href="/th/references/name-service.html" class="sidebar-item" aria-label="Name Service"><!--[--><!--]--> Name Service <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="retrying-transactions" tabindex="-1"><a class="header-anchor" href="#retrying-transactions" aria-hidden="true">#</a> Retrying Transactions</h1><p>ในบางที transaction อาจจะถูกทิ้งไปก่อนที่จะเข้าไปใน block สิ่งนี้เกิดขึ้นบ่อยในช่วงที่มีการใช้งานเยอะจนการทำงานติดขัด (network congestion) ในตอนที่ RPC node ไม่สามารถส่ง transaction ไปที่ <a href="https://docs.solana.com/terminology#leader" target="_blank" rel="noopener noreferrer">ผู้นำ (leader)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ได้ ฝั่ง end-user จะเห็นว่า transaction ได้หายไปเลย ถึง RPC nodes จะมี rebroadcasting algorithm เพื่อส่งซ้ำทั่วไปอยู่แล้ว แต่นักพัฒนา app ก็สามารทำ custom rebroadcasting logic เองได้.</p><h2 id="เรื่องน่ารู้" tabindex="-1"><a class="header-anchor" href="#เรื่องน่ารู้" aria-hidden="true">#</a> เรื่องน่ารู้</h2><div class="custom-container tip"><p class="custom-container-title">Fact Sheet</p><ul><li>RPC nodes จะพยายาม rebroadcast transactions โดยใช้ algorithm ทั่วไป</li><li>นักพัฒนา app สามารถทำ custom rebroadcasting logic เองได้</li><li>นักพัฒนา ควรใช้ <code>maxRetries</code> parameter ตอน <code>sendTransaction</code> JSON-RPC method</li><li>นักพัฒนา ควรใช้ preflight เพื่อให้เห็นปัญหาก่อนที่จะ submit transactions</li><li>ก่อนจะ re-signing transaction ใดๆ <strong>มันสำคัญมาก</strong> ที่จะแน่ใจว่า blockhash ตัวก่อนหน้าได้ expired ไปแล้ว</li></ul></div><h2 id="การเดินทางของ-transaction" tabindex="-1"><a class="header-anchor" href="#การเดินทางของ-transaction" aria-hidden="true">#</a> การเดินทางของ Transaction</h2><h3 id="clients-submit-transactions-ยังไง" tabindex="-1"><a class="header-anchor" href="#clients-submit-transactions-ยังไง" aria-hidden="true">#</a> Clients Submit Transactions ยังไง</h3><p>บน Solana จะไม่มี mempool ทุกๆ transactions ไม่ว่าจะมาจาก program หรือ end-user ก็จะถูกส่งไปที่ leaders เพื่อจะได้ไปลง block โดนจะมีอยู่ 2 ทางที่ transaction จะส่งไปถึง leaders:</p><ol><li>ผ่าน RPC server ด้วย method <a href="https://docs.solana.com/developing/clients/jsonrpc-api#sendtransaction" target="_blank" rel="noopener noreferrer">sendTransaction<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> JSON-RPC</li><li>ส่งไปตรงๆ ผ่าน <a href="https://docs.rs/solana-client/1.7.3/solana_client/tpu_client/index.html" target="_blank" rel="noopener noreferrer">TPU Client<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ol><p>end-users ส่วนใหญ่จะ submit transactions ผ่าน RPC server เมื่อ client ได้ submits transaction ไปแล้วตัว RPC node จะพยายาม broadcast transaction ไปหาทั้ง leaders ปัจจุบัน และ leaders ถัดไป จนกระทั่ง transaction ได้รับการประมวลผลจาก leader และมันจะไม่มีบันทึกของ transaction อื่นใดนอกเหนือไปจากที่ client และ RPC nodes รับรู้. ในกรณีของ TPU client, การ rebroadcast และส่งต่อไปที่ leader จะขึ้นอยู่กับ client ทั้งหมด.</p><p><img src="/assets/tx-journey.dd6310be.png" alt="การเดินทางของ Transaction"></p><h3 id="rpc-nodes-broadcast-transactions-ยังไง" tabindex="-1"><a class="header-anchor" href="#rpc-nodes-broadcast-transactions-ยังไง" aria-hidden="true">#</a> RPC Nodes Broadcast Transactions ยังไง</h3><p>หลังจาก RPC node รับ transaction ผ่าน <code>sendTransaction</code> ตัว transaction ก็จะถูกเปลี่ยนไปเป็น <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol" target="_blank" rel="noopener noreferrer">UDP<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> packet ก่อนจะส่งต่อไปที่ leaders ที่เกี่ยวข้อง การใช้ UDP จะทำให้ validators สามารถติดต่อกันได้อย่างรวดเร็ว แต่จะไม่รับประกันว่า transaction จะส่งถึงแน่นอน.</p><p>เนื่องจากการทำงานของ Solana leader จะรู้ก่อนอยู่แล้วในทุกๆ <a href="https://docs.solana.com/terminology#epoch" target="_blank" rel="noopener noreferrer">epoch<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> (~2 วัน) ตัว RPC node จะกระจาย transaction ไปหาทั้ง leaders ตัวปัจจุบัน และตัวถัดไป ตรงจุดนี้จะไม่เหมือน gossip protocols อื่นเช่น Ethereum ที่เผยแพร่ transactions แบบสุ่ม และส่งไปทั้ง network ตามปกติแล้ว RPC nodes จะพยายามส่ง transactions ไปหา leaders ทุกๆ 2 วินาที จนกระทั่ง transaction ถูก finalized หรือ blockhash หมดอายุ (150 blocks หรือ ~1 นาที 19 วินาที ณ. ตอนที่เขียนนี้). ถ้ามีคิวในการ rebroadcast ตกค้างอยู่เกิน <a href="https://github.com/solana-labs/solana/blob/bfbbc53dac93b3a5c6be9b4b65f679fdb13e41d9/send-transaction-service/src/send_transaction_service.rs#L20" target="_blank" rel="noopener noreferrer">10,000 transactions<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> จะทำให้ transactions ใหม่ถูกทิ้งไป ซึ่งจะมีคำสั่ง command-line <a href="https://github.com/solana-labs/solana/blob/bfbbc53dac93b3a5c6be9b4b65f679fdb13e41d9/validator/src/main.rs#L1172" target="_blank" rel="noopener noreferrer">arguments<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ที่คนดูแล RPC สามารถปรับเพื่อเปลี่ยนค่าเริ่มต้นของการ retry นี้ได้</p><p>เวลาที่ RPC node จะทำการเผยแพร่ transaction มันจะพยายามส่งต่ไปที่ transaction leader’s <a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/validator.rs#L867" target="_blank" rel="noopener noreferrer">Transaction Processing Unit (TPU)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> การประมวลผล transactions ของ TPU จะแบ่งเป็น 5 ขั้นตอน:</p><ul><li><a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/fetch_stage.rs#L21" target="_blank" rel="noopener noreferrer">Fetch Stage<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/tpu.rs#L91" target="_blank" rel="noopener noreferrer">SigVerify Stage<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/banking_stage.rs#L249" target="_blank" rel="noopener noreferrer">Banking Stage<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/poh/src/poh_service.rs" target="_blank" rel="noopener noreferrer">Proof of History Service<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/tpu.rs#L136" target="_blank" rel="noopener noreferrer">Broadcast Stage<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><p><img src="/assets/tpu-jito-labs.8bb32fb6.png" alt="TPU Overview"><small style="display:block;text-align:center;">Image Courtesy of Jito Labs</small></p><p>จาก 5 ขั้นตอนนี้ช่วง Fetch Stage จะรับผิดชอบการรับ transactions ตอน Fetch Stage, validators จะจัดหมวดหมู่ transactions ออกเป็น 3 ช่องทางดังนี้:</p><ul><li><a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/gossip/src/contact_info.rs#L27" target="_blank" rel="noopener noreferrer">tpu<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> จัดการ transactions พวก token transfers, NFT mints, และ program instructions</li><li><a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/gossip/src/contact_info.rs#L31" target="_blank" rel="noopener noreferrer">tpu_vote<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> จัดการเฉพาะ transactions ที่เกี่ยวกับการ vote</li><li><a href="https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/gossip/src/contact_info.rs#L29" target="_blank" rel="noopener noreferrer">tpu_forwards<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ส่งต่อ packets ที่ยังไม่ได้ดำเนินการไปยัง leader ถัดไปถ้า leader ปัจจุบัน ไม่สามารถ process ทุก transactions ได้แล้ว</li></ul><p>สำหรับเรื่อง TPU, หาอ่านเพิ่มเติมได้ที่ <a href="https://jito-labs.medium.com/solana-validator-101-transaction-processing-90bcdc271143" target="_blank" rel="noopener noreferrer">this excellent writeup by Jito Labs<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><h2 id="transactions-ถูกทิ้งไปได้ยังไง" tabindex="-1"><a class="header-anchor" href="#transactions-ถูกทิ้งไปได้ยังไง" aria-hidden="true">#</a> Transactions ถูกทิ้งไปได้ยังไง</h2><p>ตลอดการเดินทางของ transaction, อาจจะมีเหตุการณ์บางอย่างที่ทำให้ transaction ถูกทิ้งไปจาก network ได้แบบไม่ตั้งใจ.</p><h3 id="ก่อน-transaction-จะประมวลผลเสร็จ" tabindex="-1"><a class="header-anchor" href="#ก่อน-transaction-จะประมวลผลเสร็จ" aria-hidden="true">#</a> ก่อน transaction จะประมวลผลเสร็จ</h3><p>ถ้า transaction ถูกทิ้ง ส่วนใหญ่จะเกิดก่อนที่ transaction จะถูกประมวลผลโดย leader เรื่อง UDP <a href="https://en.wikipedia.org/wiki/Packet_loss" target="_blank" rel="noopener noreferrer">packet loss<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> เหตุผลว่าทำไมเรื่องนี้อาจจะเกิดขึ้นได้ในช่วงที่การใช้งาน network สูง, และมันยังเป็นไปได้ว่า validators กำลังประมวลผล transactions ที่มากเกินกว่าที่จะดำเนินการได้. ในขณะที่ validators พร้อมที่จะส่ง transactions ส่วนเกินผ่าน <code>tpu_forwards</code>, มันจะมีข้อจำกัดในการ <a href="https://github.com/solana-labs/solana/blob/master/core/src/banking_stage.rs#L389" target="_blank" rel="noopener noreferrer">ส่งต่อ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> อยู่ด้วย โดยในการส่งต่อจะถูกจำกัดให้ข้ามระหว่าง validators ได้ครั้งเดียว ดังนั้น transactions ที่ได้รับผ่าน <code>tpu_forwards</code> มาแล้ว จะไม่ถูกส่งต่อไปยัง validators อื่นอีก.</p><p>ยังมีอีก 2 เหตุผลว่าทำไม transaction อาจจะถูกทิ้งก่อนที่มันจะถูกประมวลผล. กรณีแรกมีความเกี่ยวข้องกับ transactions ที่ส่งผ่าน RPC pool ในบางครั้งบางส่วนของ RPC pool จะนำ pool อื่นๆ อยู่. เหตุการณ์นี้จะทำให้เกิดปัญหาได้ถ้า nodes ใน pool ต้องทำงานไปพร้อมๆ กัน ในตัวอย่างนี้ transaction’s <a href="https://docs.solana.com/developing/programming-model/transactions#recent-blockhash" target="_blank" rel="noopener noreferrer">recentBlockhash<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> มีการดึงข้อมูลลำดับถัดไปจาก pool (Backend A) แต่เมื่อ transaction ส่งไปในส่วนที่ pool ตามหลังอยู่ (Backend B) nodes นั้นก็จะไม่รู้จัก blockhash ถัดไป และจะทิ้ง transaction นั้นไป กรณีแบบนี้สามารถตรวจจับได้ในระหว่างการส่ง transaction ถ้านักพัฒนาเปิดใช้ <a href="https://docs.solana.com/developing/clients/jsonrpc-api#sendtransaction" target="_blank" rel="noopener noreferrer">preflight checks<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> เวลาที่เรียกใช้ <code>sendTransaction</code>.</p><p><img src="/assets/dropped-via-rpc-pool.8d1ce9af.png" alt="Dropped via RPC Pool"></p><p>การ fork network ชั่วคราวก็เป็นอีกสาเหตุที่ทำให้ transactions ถูกทิ้งถ้า validator replay blocks ไม่ทัน Banking Stage, มันอาจจะจบลงตรงที่เกิดการสร้าง minority fork ขึ้นมา เมื่อ client สร้าง transaction มันก็เป็นไปได้ว่า transaction จะถูกอ้างไปที่ <code>recentBlockhash</code> ที่มีอยู่เฉพาะใน minority fork ดังกล่าว หลังจากส่ง transaction แล้ว cluster สามารถเปลี่ยนจาก minority fork ก่อนที่ transaction จะถูกประมวลผล ในกรณีนี้ transaction จะถูกทิ้งเนื่องจาก blockhash หาไม่เจอ</p><p><img src="/assets/dropped-minority-fork-pre-process.555653e1.png" alt="Dropped due to Minority Fork (Before Processed)"></p><h3 id="หลังจาก-transaction-ประมวลผลเสร็จ-และก่อนจะ-finalized" tabindex="-1"><a class="header-anchor" href="#หลังจาก-transaction-ประมวลผลเสร็จ-และก่อนจะ-finalized" aria-hidden="true">#</a> หลังจาก transaction ประมวลผลเสร็จ และก่อนจะ finalized</h3><p>ในกรณีที่ transaction อ้างอิง <code>recentBlockhash</code> ไปที่ minority fork, มันก็ยังเป็นไปได้ที่ transaction จะถูกประมวลผล แต่อย่าสงไรก็ตามมันจะต้องถูกประมวลผลโดย leader บน minority fork. เมื่อ leader พยายามเผยแพร่ transactions นี้ไปทั้ง network มันก็จะล้มเหลว fail ที่จะไปถึงการ consensus ด้วย validators อื่นๆ ที่ไม่รู้จัก minority fork นั้นอยู่ดี ถึงจุดนี้ transaction ก็จะถูกทิ้งก่อนที่มันจะไปถึงขั้น finalized</p><p><img src="/assets/dropped-minority-fork-post-process.48c3c955.png" alt="Dropped due to Minority Fork (After Processed)"></p><h2 id="จัดการ-transactions-ที่ถูกทิ้ง" tabindex="-1"><a class="header-anchor" href="#จัดการ-transactions-ที่ถูกทิ้ง" aria-hidden="true">#</a> จัดการ Transactions ที่ถูกทิ้ง</h2><p>ตอนที่ RPC nodes พยายาม rebroadcast transactions จะใช้ algorithm ทั่วไปและ มักจะไม่ตรงกับความต้องการของ app แต่ละตัว เพื่อเตรียมตัวรับมือในช่วง network congestion นักพัฒนา app ควรออกแบบการทำงาน rebroadcasting เอง</p><h3 id="sendtransaction-เชิงลึก" tabindex="-1"><a class="header-anchor" href="#sendtransaction-เชิงลึก" aria-hidden="true">#</a> sendTransaction เชิงลึก</h3><p>เมื่อพูดถึงการส่ง transactions เราจะใช้ RPC method <code>sendTransaction</code> โดย <code>sendTransaction</code> จะรับผิดชอบในการส่ง transaction จาก client ไป RPC node ถ้า node ได้รับ transaction แล้ว, <code>sendTransaction</code> จะคืน transaction id ที่สามารถใช้ติดตาม transaction ซึ่งการที่เราได้รับ response ไม่ได้หมายความว่า transaction นั้นจะถูกประมวลผลหรือถูก finalized ด้วย cluster.</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><h4 id="request-parameters" tabindex="-1"><a class="header-anchor" href="#request-parameters" aria-hidden="true">#</a> Request Parameters</h4><ul><li><code>transaction</code>: <code>string</code> - Transaction ที่ sign เรียบร้อยแล้วในรูปแบบ encoded string</li><li>(optional) <code>configuration object</code>: <code>object</code><ul><li><code>skipPreflight</code>: <code>boolean</code> - ถ้าเป็น true, จะข้ามการทำ preflight ไป (ค่าปกติคือ: false)</li><li>(optional) <code>preflightCommitment</code>: <code>string</code> - <a href="https://docs.solana.com/developing/clients/jsonrpc-api#configuring-state-commitment" target="_blank" rel="noopener noreferrer">Commitment<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ระดับในการจำลอง preflight กับ bank slot (ค่าปกติคือ: &quot;finalized&quot;).</li><li>(optional) <code>encoding</code>: <code>string</code> - Encoding ที่ใช้สำหรับ transaction data. อาจจะเป็น &quot;base58&quot; (ช้า) หรือ &quot;base64&quot; (ค่าปกติคือ: &quot;base58&quot;).</li><li>(optional) <code>maxRetries</code>: <code>usize</code> - เลขมากที่สุดของของเวลาที่ RPC node จะพยายามส่ง transaction ไปถึง leader. ถ้าไม่กำหนด RPC node จะ retry transaction จนกระทั่งถูก finalized หรือจนกระทั่ง blockhash หมดอายุ</li></ul></li></ul><h4 id="response" tabindex="-1"><a class="header-anchor" href="#response" aria-hidden="true">#</a> Response</h4><ul><li><code>transaction id</code>: <code>string</code> - transaction signature แรกจะถูกเก็บอยู่ใน transaction ในรูปแบบ base-58 encoded string ซึ่ง transaction id นี้สามารถใช้กับ <a href="https://docs.solana.com/developing/clients/jsonrpc-api#getsignaturestatuses" target="_blank" rel="noopener noreferrer">getSignatureStatuses<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> เพื่อดึงสถานะมาดูได้.</li></ul></div><h2 id="ทํา-rebroadcast-logic-เอง" tabindex="-1"><a class="header-anchor" href="#ทํา-rebroadcast-logic-เอง" aria-hidden="true">#</a> ทำ Rebroadcast Logic เอง</h2><p>ในการที่จะพัฒนา rebroadcasting logic ด้วยตัวเอง นักพัฒนาควรใช้ <code>sendTransaction</code>, <code>maxRetries</code> parameter. ถ้ากำหนดค่า <code>maxRetries</code> มันก็จะกำหนดทับค่าปกติของ RPC node retry logic, ทำให้นักพัฒนาสามารถกำหนดช่วงการ retry <a href="https://github.com/solana-labs/solana/blob/98707baec2385a4f7114d2167ef6dfb1406f954f/validator/src/main.rs#L1258-L1274" target="_blank" rel="noopener noreferrer">ได้ตามความเหมาะสม<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><p>pattern ปกติสำหรับการ retrying transactions จะเกี่ยวข้องกับการเก็บ <code>lastValidBlockHeight</code> ที่มาจาก <a href="https://docs.solana.com/developing/clients/jsonrpc-api#getlatestblockhash" target="_blank" rel="noopener noreferrer">getLatestBlockhash<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> เมื่อเก็บไว้แล้ว app ก็สามารถ <a href="https://docs.solana.com/developing/clients/jsonrpc-api#getblockheight" target="_blank" rel="noopener noreferrer">ดึง cluster’s blockheight<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> และ retry transaction ในช่วงเวลาที่แหมาะสม. หากเกิด network congestion ก็ให้ปรับ <code>maxRetries</code> เป็น 0 ก็จะดีกว่า และ rebroadcast เองอีกที บาง app อาจจะใช้ <a href="https://en.wikipedia.org/wiki/Exponential_backoff" target="_blank" rel="noopener noreferrer">exponential backoff<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> algorithm หรือวิธีแบบ <a href="https://www.mango.markets/" target="_blank" rel="noopener noreferrer">Mango<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> เพื่อ <a href="https://github.com/blockworks-foundation/mango-ui/blob/b6abfc6c13b71fc17ebbe766f50b8215fa1ec54f/src/utils/send.tsx#L713" target="_blank" rel="noopener noreferrer">ส่ง transactions เรื่อยๆ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ในเวลาที่เหมาะสมจนเกิด timeout</p><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><!--[--><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">TS</button></li><!--]--><li class="flex-grow"></li><li class="code-group__li"><button class="code-group__nav-tab"><svg width="18" height="18" viewbox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg></button></li><li class="code-group__li"><button class="code-group__nav-tab"><svg width="18" height="18" viewbox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></button></li></ul></div><div><div class="code-info-title">Press &lt;/&gt; button to view full source</div></div><!--[--><div class="code-group-item code-group-item__active" aria-selected="true" data-v-6ae3d40e><div class="" data-v-6ae3d40e><!--[--><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Keypair<span class="token punctuation">,</span>
  Connection<span class="token punctuation">,</span>
  <span class="token constant">LAMPORTS_PER_SOL</span><span class="token punctuation">,</span>
  SystemProgram<span class="token punctuation">,</span>
  Transaction<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@solana/web3.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> nacl <span class="token keyword">from</span> <span class="token string">&quot;tweetnacl&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ms<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> payer <span class="token operator">=</span> Keypair<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> toAccount <span class="token operator">=</span> Keypair<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>publicKey<span class="token punctuation">;</span>

  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Connection</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:8899&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;confirmed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> airdropSignature <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">requestAirdrop</span><span class="token punctuation">(</span>
    payer<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span>
    <span class="token constant">LAMPORTS_PER_SOL</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">confirmTransaction</span><span class="token punctuation">(</span>airdropSignature<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> blockhashResponse <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">getLatestBlockhashAndContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> lastValidBlockHeight <span class="token operator">=</span> blockhashResponse<span class="token punctuation">.</span>context<span class="token punctuation">.</span>slot <span class="token operator">+</span> <span class="token number">150</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> transaction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    feePayer<span class="token operator">:</span> payer<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span>
    blockhash<span class="token operator">:</span> blockhashResponse<span class="token punctuation">.</span>value<span class="token punctuation">.</span>blockhash<span class="token punctuation">,</span>
    lastValidBlockHeight<span class="token operator">:</span> lastValidBlockHeight<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
    SystemProgram<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      fromPubkey<span class="token operator">:</span> payer<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span>
      toPubkey<span class="token operator">:</span> toAccount<span class="token punctuation">,</span>
      lamports<span class="token operator">:</span> <span class="token number">1000000</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">serializeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> signature <span class="token operator">=</span> nacl<span class="token punctuation">.</span>sign<span class="token punctuation">.</span><span class="token function">detached</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> payer<span class="token punctuation">.</span>secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  transaction<span class="token punctuation">.</span><span class="token function">addSignature</span><span class="token punctuation">(</span>payer<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rawTransaction <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> blockheight <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">getBlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>blockheight <span class="token operator">&lt;</span> lastValidBlockHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connection<span class="token punctuation">.</span><span class="token function">sendRawTransaction</span><span class="token punctuation">(</span>rawTransaction<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      skipPreflight<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blockheight <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">getBlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><!--]--></div><div class="hidden" data-v-6ae3d40e><!--[--><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">while</span> <span class="token punctuation">(</span>blockheight <span class="token operator">&lt;</span> lastValidBlockHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  connection<span class="token punctuation">.</span><span class="token function">sendRawTransaction</span><span class="token punctuation">(</span>rawTransaction<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    skipPreflight<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  blockheight <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">getBlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><!--]--></div></div><!--]--></div><p>เมื่อดึงข้อมูลผ่าน <code>getLatestBlockhash</code> ตัว app ควรจะระบุ <a href="https://docs.solana.com/developing/clients/jsonrpc-api#configuring-state-commitment" target="_blank" rel="noopener noreferrer">commitment<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> level ที่ต้องการไว้ด้วย เช่นถ้าเรากำหนดไว้เป็น <code>confirmed</code> (รอจบการโหวต) หรือ <code>finalized</code> (~30 blocks หลังจาก <code>confirmed</code>) app จะสามารถเลี่ยงกรณีได้ blockhash จาก minority fork ไปได้</p><p>ถ้า app เข้าถึง RPC nodes หลัง load balancer มันจะสามารถเลือกที่จะกระจาย workload ไปที่ nodes ที่ต้องการได้ด้วย ซึ่ง RPC nodes ที่ให้รองรับการร้องขอ data ที่ต้องประมวลผลหนักๆ เช่น <a href="/th/guides/get-program-accounts.html" class="">getProgramAccounts</a> อาจจะทำให้ node นี้ทำงานช้ากว่า node อื่นๆ และ จะไม่สามารถส่ง transactions ต่อได้. สำหรับ applications ที่จัดการ transactions ที่ต้องการความเร็วสูง อาจจะเป็นการดีกว่าถ้าใช้ node ที่รองรับ <code>sendTransaction</code> อย่างเดียว</p><h3 id="จะเกิดอะไรขึ้นถ้า-skip-preflight" tabindex="-1"><a class="header-anchor" href="#จะเกิดอะไรขึ้นถ้า-skip-preflight" aria-hidden="true">#</a> จะเกิดอะไรขึ้นถ้า Skip Preflight</h3><p>โดยค่าเริ่มต้น <code>sendTransaction</code> จะทำการตรวจสอบล่วงหน้าสามครั้งก่อนที่จะส่ง transaction. โดยเฉพาะ <code>sendTransaction</code> จะ:</p><ul><li>ตรวจสอบว่าทุกๆ signatures ถูกต้องหรือไม่</li><li>ตรวจสอบว่า blockhash ที่ใส่มาอยุ่ในช่วงไม่เกิน 150 blocks</li><li>จำลอง transaction กับ bank slot ตามที่ระบุไว้ที่ <code>preflightCommitment</code></li></ul><p>ในกรณีที่การตรวจสอบล่วงหน้าสามครั้งล้มเหลว <code>sendTransaction</code> จะแสดง error ก่อนจะส่ง transaction. Preflight checks สามารถบอกได้ว่า transaction จะถูกทิ้งหรือไม่ และทำให้ client สามารถจัดการกับ error นั้นๆ ได้ เพื่อให้ error ที่อาจจะเกิดขึ้นได้ ได้รับการจัดการเราแนะนำว่านักพัฒนาควร ตั้งค่า <code>skipPreflight</code> เป็น <code>false</code></p><h3 id="re-sign-transactions-เมื่อไหร่ดี" tabindex="-1"><a class="header-anchor" href="#re-sign-transactions-เมื่อไหร่ดี" aria-hidden="true">#</a> Re-Sign Transactions เมื่อไหร่ดี</h3><p>ถึงเราจะพยายาม rebroadcast แล้วก็ตามแต่ก็จะมีบางเวลาที่ client จะต้อง sign transaction อีกครั้ง ซึ่งก่อนที่จะ sign transaction ใหม่นั้น <strong>มันสำคัญมาก</strong> ทีี่เราจะต้องมั่นใจว่า transaction’s blockhash ได้หมดอายุไปแล้ว ถ้า blockhash ยังไม่หมดอายุมันก็เป็นไปได้ที่ transactions ทั้งคู่จะผ่านเข้า network ไปได้ และในส่วนของ end-user จะเห็นว่าส่ง transaction เดิมไป 2 รอบ.</p><p>บน Solana นั้นการทิ้ง transaction สามารถทำได้อย่างปลอดภัยถ้า blockhash เก่ากว่า <code>lastValidBlockHeight</code> ที่ได้จากการ <code>getLatestBlockhash</code> นักพัฒนาต้องคอยดู <code>lastValidBlockHeight</code> ด้วยการ <a href="https://docs.solana.com/developing/clients/jsonrpc-api#getepochinfo" target="_blank" rel="noopener noreferrer"><code>getEpochInfo</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> และเทียบกับ <code>blockHeight</code> ที่ได้คืนมา เมื่อ blockhash หมดอายุแล้ว clients ก็สามารถ sign อีกครั้งได้ด้วย blockhash ที่ไปดึงมาใหม่.</p><h2 id="acknowledgements" tabindex="-1"><a class="header-anchor" href="#acknowledgements" aria-hidden="true">#</a> Acknowledgements</h2><p>ขอขอบคุณ Trent Nelson, <a href="https://twitter.com/jacobvcreech" target="_blank" rel="noopener noreferrer">Jacob Creech<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, White Tiger, Le Yafo, <a href="https://twitter.com/buffalu__" target="_blank" rel="noopener noreferrer">Buffalu<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, และ <a href="https://twitter.com/jito_labs" target="_blank" rel="noopener noreferrer">Jito Labs<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ที่ช่วย review และแนะนำ</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/th/guides/account-maps.html" class="" aria-label="Account Maps"><!--[--><!--]--> Account Maps <!--[--><!--]--></a></span><span class="next"><a href="/th/guides/debugging-solana-programs.html" class="" aria-label="Debugging Solana Programs"><!--[--><!--]--> Debugging Solana Programs <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.28f6b3e6.js" defer></script>
  </body>
</html>
